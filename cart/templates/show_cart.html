{% extends 'base.html' %}

{% block content %}
  <div class="flex justify-center items-start min-h-screen py-6" style="background: linear-gradient(153deg, #F09027 12.76%, #8CBEAA 71.77%);">
    <div class="bg-white bg-opacity-70 shadow-md rounded-lg p-6 w-full max-w-2xl">
      <h2 class="text-2xl font-semibold mb-4">My Cart</h2>

      {% if cart %}
        <form id="cartForm">
          <table class="min-w-full border bg-white bg-opacity-50 border-gray-200 rounded-lg">
            <tbody>
              {% for item in cart %}
                <tr data-item-id="{{ item.id }}">
                  <td class="py-2 px-4 border-b" rowspan="2">
                    <input type="checkbox" class="cart-checkbox" data-price="{{ item.total_price }}" />
                  </td>
                  <td class="py-2 px-4 border-b" rowspan="2">
                    <div class="w-36 h-36 overflow-hidden border border-gray-300 rounded-lg">
                      <img src="/media/{{ item.product.picture }}" alt="{{ item.product.name }}" class="w-full h-full object-cover" />
                    </div>
                  </td>
                  <td class="py-2 px-4 border-b">
                    <div class="flex flex-col items-start justify-start">
                      <span class="font-semibold">{{ item.product.name }}</span>
                      <span class="text-gray-500">Rp{{ item.product.price|floatformat:0 }}</span>
                    </div>
                  </td>
                  <td class="py-2 px-4 border-b">
                    <div class="flex flex-col items-end justify-end">
                      <div>
                        Rp<span class="item-total-price">{{ item.total_price|floatformat:0 }}</span>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td></td>
                  <td class="py-2 px-4 border-b" colspan="2">
                    <div class="flex items-center justify-end">
                      <div class="mr-2">
                        <button class="text-white bg-red-500 px-2 py-1 my-2 rounded transition-colors duration-200 ease-in-out delete" onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'" data-item-id="{{ item.id }}">Delete</button>
                      </div>
                      <button class="bg-gray-300 text-black px-2 py-1 rounded mr-2 decrement" data-item-id="{{ item.id }}">-</button>
                      <span class="item-amount">{{ item.amount }}</span>
                      <button class="bg-gray-300 text-black px-2 py-1 rounded ml-2 increment" data-item-id="{{ item.id }}">+</button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </form>
      {% else %}
        <p class="text-center mt-4">Your cart is empty.</p>
      {% endif %}

      <div class="mt-6 text-center">
        <a href="{% url 'display:display_main' %}" class="bg-gray-300 hover:bg-gray-400 text-white px-4 py-2 rounded" style="background-color: #67BAC6;">Back to Products</a>
      </div>
    </div>

    <!-- Total Price Box -->
    <div class="bg-white bg-opacity-70 shadow-md rounded-lg p-6 ml-6 w-64">
      <h2 class="text-xl font-semibold mb-4">Total Price</h2>
      <p class="text-lg">
        Rp<span id="totalPrice">0</span>
      </p>
      <button class="text-white px-2 py-1 my-2 rounded w-full transition-colors duration-200 ease-in-out" style="background-color: #67BAC6;" onmouseover="this.style.backgroundColor='#8DCAD4'" onmouseout="this.style.backgroundColor='#67BAC6'" onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'">Check Out</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const decrementButtons = document.querySelectorAll('.decrement')
      const incrementButtons = document.querySelectorAll('.increment')
      const deleteButtons = document.querySelectorAll('.delete')
      const totalPriceElement = document.getElementById('totalPrice')
      const checkboxes = document.querySelectorAll('.cart-checkbox')
    
      function updateAmount(itemId, action, event) {
        event.preventDefault()
    
        fetch(`/cart/${action}_amount/${itemId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const itemRow = document.querySelector(`[data-item-id="${itemId}"]`)
              const nextRow = itemRow.nextElementSibling
              const amountElement = nextRow.querySelector('.item-amount')
              const totalPriceElement = itemRow.querySelector('.item-total-price')
    
              amountElement.textContent = data.new_amount
              totalPriceElement.textContent = data.new_total_price.toLocaleString()
    
              const checkbox = itemRow.querySelector('.cart-checkbox')
              if (checkbox) {
                checkbox.setAttribute('data-price', data.new_total_price)
              }
    
              updateTotalPrice()
            }
          })
          .catch((error) => console.error('Error:', error))
      }
    
      function deleteItem(itemId, event) {
        event.preventDefault()
    
        fetch(`/cart/delete/${itemId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        })
          .then((response) => {
            // Simply reload the page after successful deletion
            if (response.ok) {
              window.location.reload()
            } else {
              throw new Error('Failed to delete item')
            }
          })
          .catch((error) => {
            console.error('Error:', error)
            alert('Failed to delete item. Please try again.')
          })
      }
    
      function updateTotalPrice() {
        let total = 0
        checkboxes.forEach((checkbox) => {
          if (checkbox.checked) {
            total += parseFloat(checkbox.getAttribute('data-price'))
          }
        })
        totalPriceElement.textContent = total.toLocaleString()
      }
    
      incrementButtons.forEach((button) => {
        button.addEventListener('click', function (event) {
          const itemId = this.getAttribute('data-item-id')
          updateAmount(itemId, 'inc', event)
        })
      })
    
      decrementButtons.forEach((button) => {
        button.addEventListener('click', function (event) {
          const itemId = this.getAttribute('data-item-id')
          updateAmount(itemId, 'dec', event)
        })
      })
    
      deleteButtons.forEach((button) => {
        button.addEventListener('click', function (event) {
          const itemId = this.getAttribute('data-item-id')
          if (confirm('Are you sure you want to remove this item from your cart?')) {
            deleteItem(itemId, event)
          }
        })
      })
    
      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener('change', updateTotalPrice)
      })
    })
  </script>
{% endblock %}
